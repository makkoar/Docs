# Трансформеры доступа (Access Transformers)

Трансформеры доступа (Access Transformers, сокращенно AT) позволяют расширять видимость и изменять флаги `final` классов, методов и полей. Они дают моддерам возможность получать доступ и изменять недоступные иным образом члены классов, находящихся вне их контроля.

[Документацию по спецификации](https://github.com/NeoForged/AccessTransformers/blob/main/FMLAT.md) можно посмотреть на GitHub NeoForged.

<a id="adding-ats"></a>
## Добавление AT

Добавить Access Transformer в ваш проект мода так же просто, как добавить одну строку в ваш `build.gradle`:

Трансформеры доступа должны быть объявлены в `build.gradle`. Файлы AT могут быть указаны где угодно, при условии, что они копируются в выходную директорию `resources` при компиляции.

```groovy
// В build.gradle:
// Этот блок также используется для указания версии маппингов
minecraft {
    accessTransformers {
        file('src/main/resources/META-INF/accesstransformer.cfg')
    }
}
```

По умолчанию NeoForge будет искать `META-INF/accesstransformer.cfg`. Если `build.gradle` указывает трансформеры доступа в другом месте, то их расположение нужно определить в `neoforge.mods.toml`:

```toml
# В neoforge.mods.toml:
[[accessTransformers]]
## Путь к файлу указывается относительно выходной директории ресурсов или корневого пути внутри jar-файла после компиляции
## Директория 'resources' представляет корневую выходную директорию ресурсов
file="META-INF/accesstransformer.cfg"
```

Кроме того, можно указать несколько файлов AT, и они будут применены по порядку. Это может быть полезно для больших модов с множеством пакетов.

```groovy
// В build.gradle:
minecraft {
    accessTransformers {
        file('src/main/resources/accesstransformer_main.cfg')
        file('src/additions/resources/accesstransformer_additions.cfg')
    }
}
```

```toml
# В neoforge.mods.toml
[[accessTransformers]]
file="accesstransformer_main.cfg"

[[accessTransformers]]
file="accesstransformer_additions.cfg"
```

После добавления или изменения любого Access Transformer необходимо обновить проект Gradle, чтобы трансформации вступили в силу.

## Спецификация Access Transformer

### Комментарии

Весь текст после символа `#` до конца строки будет считаться комментарием и не будет обрабатываться.

### Модификаторы доступа

Модификаторы доступа указывают, на какую новую видимость будет изменен указанный целевой элемент. В порядке убывания видимости:

*   `public` - виден всем классам внутри и вне его пакета
*   `protected` - виден только классам внутри пакета и подклассам
*   `default` - виден только классам внутри пакета (модификатор по умолчанию, не указывается явно в Java, но является ключевым словом для AT)
*   `private` - виден только внутри класса

К вышеупомянутым модификаторам можно добавить специальный модификатор `+f` или `-f`, чтобы добавить или удалить соответственно модификатор `final`, который предотвращает наследование классов, переопределение методов или изменение полей.

> **Внимание:**
> Директивы изменяют только тот метод, на который они непосредственно ссылаются; любые переопределяющие методы не будут трансформированы. Рекомендуется убедиться, что трансформированные методы не имеют нетрансформированных переопределений, которые ограничивают видимость, так как это приведет к ошибке JVM.
>
> Примеры методов, которые можно безопасно трансформировать: `private` методы, `final` методы (или методы в `final` классах) и `static` методы.

### Цели и директивы

#### Классы

Для указания классов:

```text
<модификатор доступа> <полное имя класса>
```

Внутренние классы обозначаются путем объединения полного имени внешнего класса и имени внутреннего класса с использованием разделителя `$`.

#### Поля

Для указания полей:

```text
<модификатор доступа> <полное имя класса> <имя поля>
```

#### Методы

Для указания методов требуется специальный синтаксис для обозначения параметров метода и типа возвращаемого значения:

```text
<модификатор доступа> <полное имя класса> <имя метода>(<типы параметров>)<тип возвращаемого значения>
```

##### Указание типов

Также называемые "дескрипторами": см. [Спецификацию виртуальной машины Java, SE 21, разделы 4.3.2 и 4.3.3](https://docs.oracle.com/javase/specs/jvms/se21/html/jvms-4.html#jvms-4.3.2) для более технических деталей.

*   `B` - `byte`, знаковый байт
*   `C` - `char`, кодовая точка символа Unicode в UTF-16
*   `D` - `double`, значение с плавающей точкой двойной точности
*   `F` - `float`, значение с плавающей точкой одинарной точности
*   `I` - `integer`, 32-битное целое число
*   `J` - `long`, 64-битное целое число
*   `S` - `short`, знаковое короткое целое
*   `Z` - `boolean`, значение `true` или `false`
*   `[` - обозначает одно измерение массива
    *   Пример: `[[S` соответствует `short[][]`
*   `L<имя класса>;` - обозначает ссылочный тип
    *   Пример: `Ljava/lang/String;` соответствует ссылочному типу `java.lang.String` *(обратите внимание на использование слешей вместо точек)*
*   `(` - начало дескриптора метода, здесь указываются параметры или ничего, если параметров нет
    *   Пример: `<метод>(I)Z` соответствует методу, который принимает целочисленный аргумент и возвращает boolean
*   `V` - указывает, что метод не возвращает значения (`void`), может использоваться только в конце дескриптора метода
    *   Пример: `<метод>()V` соответствует методу без аргументов, который ничего не возвращает

### Примеры

```text
# Делает публичным интерфейс ByteArrayToKeyFunction в классе Crypt
public net.minecraft.util.Crypt$ByteArrayToKeyFunction

# Делает protected и удаляет модификатор final у поля 'random' в MinecraftServer
protected-f net.minecraft.server.MinecraftServer random

# Делает публичным метод 'makeExecutor' в классе Util,
# принимающий String и возвращающий TracingExecutor
public net.minecraft.Util makeExecutor(Ljava/lang/String;)Lnet/minecraft/TracingExecutor;

# Делает публичным метод 'leastMostToIntArray' в классе UUIDUtil,
# принимающий два long и возвращающий int[]
public net.minecraft.core.UUIDUtil leastMostToIntArray(JJ)[I
```
---
<div align="center"><table border="1"><tr><td align="center">Предыдущий раздел<br><a href="../networking/configuration-tasks.md">Использование задач конфигурации</a></td><td align="center">Следующий раздел<br><a href="extensible-enums.md">Расширяемые перечисления</a></td></tr></table></div>
